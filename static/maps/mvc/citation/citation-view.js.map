{"version":3,"sources":["mvc/citation/citation-view.js"],"names":["CitationView","Backbone","View","extend","tagName","className","render","this","$el","append","formattedReference","model","entryType","fields","ref","authorsAndYear","_asSentence","author","year","title","pages","address","volume","number","journal","booktitle","note","institution","doiUrl","type","url","_formatBookInfo","doi","chapter","info","el","publisher","editor","series","str","issn","trim","CitationListView","events","initialize","renderCitation","collection","citation","rawTextarea","click .citations-to-formatted","citationView","each","item","$","showFormatted","val","attributes","content","showBibtex","citationsElement","show","hide","select","partial","join","_localization2","default","partialWarningElement"],"mappings":"0QAGIA,EAAeC,SAASC,KAAKC,QAC7BC,QAAS,MACTC,UAAW,YACXC,OAAQ,WAEJ,OADAC,KAAKC,IAAIC,OAAT,MAAsBF,KAAKG,qBAA3B,QACOH,MAEXG,mBAAoB,WAChB,IAAIC,EAAQJ,KAAKI,MACbC,EAAYD,EAAMC,YAClBC,EAASF,EAAME,SAEfC,EAAM,GAGNC,EAAoBR,KAAKS,aAfjChB,EAAAA,OAAeC,EAAAgB,OAAqB,KAAAJ,EAAAK,KAAA,KAAAL,EAAAK,KAAA,IAAA,KAe5B,IAbRb,EAAWQ,EAAAM,OAFyB,GAGpCb,EAAQO,EAAAO,MAAA,OAAWP,EAAAO,MAAA,GACfC,EAASZ,EAATY,QACA,GAAA,WAAAT,EAAA,CALgC,IAAAU,GAOpCZ,EAAAA,OAAoBG,EAAAS,OAAA,KACZX,EAAQY,OAARZ,KAAJE,EAAAU,OAAIZ,IAAJ,KACIC,EAAAA,KAAYD,EAAMC,IACtBE,EAAID,EAiBIN,KAAKS,YAAYG,IAfrBL,EAAJU,QAAIV,UAAJD,EAAAW,QAAIV,KAAJ,IACAP,KAAAS,YAAAM,GACAf,KAAAS,YAAAH,EAAAQ,SAJA,aAQAP,EAHIC,iBAAAA,GACC,eAAAF,EAEDM,EACAC,KAAAA,YAAeA,IACfC,EAAAA,UAAAA,UAAJR,EAAAY,UAAIJ,KAAJ,KACIT,GAAa,KACbS,EAAAA,KACKR,EAAA,IALT,SAQaE,iBAATD,GAAS,aACAE,EAKTF,EADGP,KAMAS,YAAIJ,IACPE,EACIC,aACAF,EAAKG,aAFTF,KAGKD,KAJFA,EAMID,KAAAA,EAAac,KANjB,IAM+B,IAE9BX,cADJD,EAOAA,EADGP,KAEAS,YAAAG,GACHL,KAAAA,YAASC,EAATY,aAGHpB,KAAAS,YAAAH,EAAAU,QACGK,KAAAA,YAAJf,EAAAgB,MACgB,QAAZhB,GAAY,UAAAD,GAAA,gBAAAA,EACZgB,EAAAA,IAAAA,KAAAA,gBAAAf,GAEHE,EAAA,IAAAR,KAAAS,YAAAG,GAAAZ,KAAAS,YACGc,EAAMjB,cACNiB,KAAKd,YAAAH,EAAAa,MAER,IAAAE,EAAA,GACDf,EAAOC,MAEXiB,GAAAA,cApEoCH,EAAAA,qBAAAf,EAAAmB,KAoEpCD,yBAAkClB,EAAAmB,IAAlCD,SAEI,IAAAD,EAAIjB,EAAOoB,KAASL,EAIhBM,OAHAA,IACHpB,GAAAA,aAAAgB,EAAA,+BAEGI,GAEJH,gBAAIlB,SAAJA,GACIqB,IAAAA,EAAAA,GAyBRC,OAxBKtB,EAAAoB,UACDC,GAAWE,EAAAA,QAAX,QAECvB,EAAAM,QACDe,GAAAA,OAAWd,EAAOD,MAAlB,SAECN,EAAAwB,SACDH,GAAAA,eAAmBrB,EAAAwB,OAAnB,MAECxB,EAAAuB,YACDF,GAAAA,KAAWZ,EAAQc,WAElBvB,EAAAO,QACDc,GAAAA,SAAiBrB,EAAAO,OAEhBP,EAAAyB,SACDJ,GAAAA,SAAArB,EAAAyB,OAAA,SAEJtB,EAAAA,SACIkB,GAAAA,SAAcK,EAAPjB,QAjGfT,EAAA2B,OA4FYN,GAAAA,WAAmBrB,EAAO2B,MAU9BN,EAAJC,KANAnB,YAAa,SAASuB,GAClB,OAAOA,GAAOA,EAAIE,OAAYF,EAAvB,KAAiC,MAI5CG,EAAmBzC,SAASC,KAAKC,QASjCwC,GAAAA,aAJAC,WAAY,WASZC,KAAAA,SAAAA,KAAgBC,WAAA,MAAAvC,KAASwC,iBAGrBJ,QACAK,6BAAmBA,aACtBC,gCAnBuC,iBAsBpCJ,eAAA,SAAcE,GACd,IAAAG,EAAA,IAAgBC,GAAcC,MAAML,IAChCxC,KAAA8C,EAAA,wBAAoBD,OAApBF,EAAA5C,SAAA6B,IACH,IAAAa,EAFDzC,KAAA8C,EAAA,0BAGAL,EAAKM,IAAAA,EAALC,MAAA,OAAAR,EAAAS,WAAAC,UAGJC,OAAAA,WACInD,KAAAC,IAAK6C,KAAE9C,KAAAoD,oBACPpD,KAAAuC,WAAOK,KAAA,SAAAC,GACP7C,KAAK8C,eAAED,IACP7C,MACAA,KAAA+C,iBAGJA,WAAAA,WACI/C,KAAA8C,EAAA,2BAAOO,OACPrD,KAAA8C,EAAA,wBAAOQ,OACPtD,KAAA8C,EAAA,qBAAOO,OACPrD,KAAA8C,EAAA,wBAAOQ,OACVtD,KA1CuC8C,EAAA,0BAAAS,UA6CpCR,cAAI,WACA/C,KAAA8C,EAAA,2BACIQ,OAQPtD,KAVD8C,EAAA,wBAUOO,OACHrD,KAAA8C,EAAA,qBAAAQ,OACHtD,KAAA8C,EAAA,wBAAAO,QAGLD,sBAAkB,WACd,OAAApD,KAAAuC,WACIiB,SA9DZ,iCAgDgB,sFAgChB,qFA9BgB,iDAgCZ/D,4FACA0C,sEA9BY,UACFsB,KAAK,IAEA,IAIfL,iBAAkB,WACd,OACI,yBACA,+BACA,EAAAM,EAAAC,SAAG,aACH,8JACA,+JACA,SACA,sDACA3D,KAAK4D,wBACL,2EACA,SACA,uEACA,0FACA,SACA,UACFH,KAAK,kBAMXhE,aAAcA,EACd0C,iBAAkBA","file":"../../../scripts/mvc/citation/citation-view.js","sourcesContent":["import baseMVC from \"mvc/base-mvc\";\nimport citationModel from \"mvc/citation/citation-model\";\nimport _l from \"utils/localization\";\nvar CitationView = Backbone.View.extend({\n    tagName: \"div\",\n    className: \"citations\",\n    render: function() {\n        this.$el.append(`<p>${this.formattedReference()}</p>`);\n        return this;\n    },\n    formattedReference: function() {\n        var model = this.model;\n        var entryType = model.entryType();\n        var fields = model.fields();\n\n        var ref = \"\";\n        // Code inspired by...\n        // https://github.com/vkaravir/bib-publication-list/blob/master/src/bib-publication-list.js\n        var authorsAndYear = `${this._asSentence(\n            (fields.author ? fields.author : \"\") + (fields.year ? ` (${fields.year})` : \"\")\n        )} `;\n        var title = fields.title || \"\";\n        var pages = fields.pages ? `pp. ${fields.pages}` : \"\";\n        var address = fields.address;\n        if (entryType == \"article\") {\n            var volume =\n                (fields.volume ? fields.volume : \"\") +\n                (fields.number ? ` (${fields.number})` : \"\") +\n                (pages ? `, ${pages}` : \"\");\n            ref = `${authorsAndYear +\n                this._asSentence(title) +\n                (fields.journal ? `In <em>${fields.journal}, ` : \"\") +\n                this._asSentence(volume) +\n                this._asSentence(fields.address)}</em>`;\n        } else if (entryType == \"inproceedings\" || entryType == \"proceedings\") {\n            ref = `${authorsAndYear +\n                this._asSentence(title) +\n                (fields.booktitle ? `In <em>${fields.booktitle}, ` : \"\") +\n                (pages ? pages : \"\") +\n                (address ? `, ${address}` : \"\")}.</em>`;\n        } else if (entryType == \"mastersthesis\" || entryType == \"phdthesis\") {\n            ref =\n                authorsAndYear +\n                this._asSentence(title) +\n                (fields.howpublished ? `${fields.howpublished}. ` : \"\") +\n                (fields.note ? `${fields.note}.` : \"\");\n        } else if (entryType == \"techreport\") {\n            ref =\n                authorsAndYear +\n                this._asSentence(title) +\n                this._asSentence(fields.institution) +\n                this._asSentence(fields.number) +\n                this._asSentence(fields.type);\n        } else if (entryType == \"book\" || entryType == \"inbook\" || entryType == \"incollection\") {\n            ref = `${authorsAndYear} ${this._formatBookInfo(fields)}`;\n        } else {\n            ref = `${authorsAndYear} ${this._asSentence(title)}${this._asSentence(\n                fields.howpublished\n            )}${this._asSentence(fields.note)}`;\n        }\n        var doiUrl = \"\";\n        if (fields.doi) {\n            doiUrl = `http://dx.doi.org/${fields.doi}`;\n            ref += `[<a href=\"${doiUrl}\" target=\"_blank\">doi:${fields.doi}</a>]`;\n        }\n        var url = fields.url || doiUrl;\n        if (url) {\n            ref += `[<a href=\"${url}\" target=\"_blank\">Link</a>]`;\n        }\n        return ref;\n    },\n    _formatBookInfo: function(fields) {\n        var info = \"\";\n        if (fields.chapter) {\n            info += `${fields.chapter} in `;\n        }\n        if (fields.title) {\n            info += `<em>${fields.title}</em>`;\n        }\n        if (fields.editor) {\n            info += `, Edited by ${fields.editor}, `;\n        }\n        if (fields.publisher) {\n            info += `, ${fields.publisher}`;\n        }\n        if (fields.pages) {\n            info += `, pp. ${fields.pages}`;\n        }\n        if (fields.series) {\n            info += `, <em>${fields.series}</em>`;\n        }\n        if (fields.volume) {\n            info += `, Vol.${fields.volume}`;\n        }\n        if (fields.issn) {\n            info += `, ISBN: ${fields.issn}`;\n        }\n        return `${info}.`;\n    },\n    _asSentence: function(str) {\n        return str && str.trim() ? `${str}. ` : \"\";\n    }\n});\n\nvar CitationListView = Backbone.View.extend({\n    el: \"#citations\",\n    /**\n     * Set up view.\n     */\n    initialize: function() {\n        this.listenTo(this.collection, \"add\", this.renderCitation);\n    },\n\n    events: {\n        \"click .citations-to-bibtex\": \"showBibtex\",\n        \"click .citations-to-formatted\": \"showFormatted\"\n    },\n\n    renderCitation: function(citation) {\n        var citationView = new CitationView({ model: citation });\n        this.$(\".citations-formatted\").append(citationView.render().el);\n        var rawTextarea = this.$(\".citations-bibtex-text\");\n        rawTextarea.val(`${rawTextarea.val()}\\n\\r${citation.attributes.content}`);\n    },\n\n    render: function() {\n        this.$el.html(this.citationsElement());\n        this.collection.each(function(item) {\n            this.renderCitation(item);\n        }, this);\n        this.showFormatted();\n    },\n\n    showBibtex: function() {\n        this.$(\".citations-to-formatted\").show();\n        this.$(\".citations-to-bibtex\").hide();\n        this.$(\".citations-bibtex\").show();\n        this.$(\".citations-formatted\").hide();\n        this.$(\".citations-bibtex-text\").select();\n    },\n\n    showFormatted: function() {\n        this.$(\".citations-to-formatted\").hide();\n        this.$(\".citations-to-bibtex\").show();\n        this.$(\".citations-bibtex\").hide();\n        this.$(\".citations-formatted\").show();\n    },\n\n    partialWarningElement: function() {\n        if (this.collection.partial) {\n            return [\n                '<div style=\"padding:5px 10px\">',\n                \"<b>Warning: This is a experimental feature.</b> Most Galaxy tools will not annotate\",\n                \" citations explicitly at this time. When writing up your analysis, please manually\",\n                \" review your histories and find all references\",\n                \" that should be cited in order to completely describe your work. Also, please remember to\",\n                ' <a href=\"https://galaxyproject.org/citing-galaxy\">cite Galaxy</a>.',\n                \"</div>\"\n            ].join(\"\");\n        } else {\n            return \"\";\n        }\n    },\n\n    citationsElement: function() {\n        return [\n            '<div class=\"toolForm\">',\n            '<div class=\"toolFormTitle\">',\n            _l(\"Citations\"),\n            ' <button type=\"button\" class=\"btn btn-xs citations-to-bibtex\" title=\"Show all in BibTeX format.\"><i class=\"fa fa-pencil-square-o\"></i> Show BibTeX</button>',\n            ' <button type=\"button\" class=\"btn btn-xs citations-to-formatted\" title=\"Return to formatted citation list.\"><i class=\"fa fa-times\"></i> Hide BibTeX</button>',\n            \"</div>\",\n            '<div class=\"toolFormBody\" style=\"padding:5px 10px\">',\n            this.partialWarningElement(),\n            '<span class=\"citations-formatted\" style=\"word-wrap: break-word;\"></span>',\n            \"</div>\",\n            '<div class=\"citations-bibtex toolFormBody\" style=\"padding:5px 10px\">',\n            '<textarea style=\"width: 100%; height: 500px;\" class=\"citations-bibtex-text\"></textarea>',\n            \"</div>\",\n            \"</div>\"\n        ].join(\"\");\n    }\n});\n\n//==============================================================================\nexport default {\n    CitationView: CitationView,\n    CitationListView: CitationListView\n};\n"]}