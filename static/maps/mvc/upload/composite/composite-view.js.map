{"version":3,"sources":["mvc/upload/composite/composite-view.js"],"names":["Backbone","View","extend","collection","_uploadModel2","default","Collection","initialize","app","self","this","options","list_extensions","list_genomes","ftp_upload_site","currentFtp","setElement","_template","btnStart","_uiMisc2","Button","title","onclick","_eventStart","btnClose","modal","hide","_","each","$el","select_extension","_uiSelect2","$","ext","composite_files","onchange","extension","reset","findWhere","details","item","add","id","size","file_desc","description","name","container","data","filter","_uploadExtension2","e","target","value","list","select_genome","css","default_genome","model","placement","render","first","get","disable","enable","listenTo","where","length","_eventAnnounce","addClass","removeClass","upload_row","append","set","genome","uploadpost","url","nginx_upload_path","toData","message","error","progress","percentage","_eventProgress","it","_eventSuccess","Galaxy","currHistoryPanel","refreshContents","_eventError","status","info"],"mappings":"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","file":"../../../../scripts/mvc/upload/composite/composite-view.js","sourcesContent":["/** Renders contents of the composite uploader */\nimport Utils from \"utils/utils\";\nimport UploadModel from \"mvc/upload/upload-model\";\nimport UploadRow from \"mvc/upload/composite/composite-row\";\nimport UploadExtension from \"mvc/upload/upload-extension\";\nimport Popover from \"mvc/ui/ui-popover\";\nimport Select from \"mvc/ui/ui-select\";\nimport Ui from \"mvc/ui/ui-misc\";\nexport default Backbone.View.extend({\n    collection: new UploadModel.Collection(),\n    initialize: function(app) {\n        var self = this;\n        this.app = app;\n        this.options = app.options;\n        this.list_extensions = app.list_extensions;\n        this.list_genomes = app.list_genomes;\n        this.ftp_upload_site = app.currentFtp();\n        this.setElement(this._template());\n\n        // create button section\n        this.btnStart = new Ui.Button({\n            title: \"Start\",\n            onclick: function() {\n                self._eventStart();\n            }\n        });\n        this.btnClose = new Ui.Button({\n            title: \"Close\",\n            onclick: function() {\n                self.app.modal.hide();\n            }\n        });\n\n        // append buttons to dom\n        _.each([this.btnStart, this.btnClose], button => {\n            self.$(\".upload-buttons\").prepend(button.$el);\n        });\n\n        // select extension\n        this.select_extension = new Select.View({\n            css: \"upload-footer-selection\",\n            container: this.$(\".upload-footer-extension\"),\n            data: _.filter(this.list_extensions, ext => ext.composite_files),\n            onchange: function(extension) {\n                self.collection.reset();\n                var details = _.findWhere(self.list_extensions, {\n                    id: extension\n                });\n                if (details && details.composite_files) {\n                    _.each(details.composite_files, item => {\n                        self.collection.add({\n                            id: self.collection.size(),\n                            file_desc: item.description || item.name\n                        });\n                    });\n                }\n            }\n        });\n\n        // handle extension info popover\n        this.$(\".upload-footer-extension-info\")\n            .on(\"click\", e => {\n                new UploadExtension({\n                    $el: $(e.target),\n                    title: self.select_extension.text(),\n                    extension: self.select_extension.value(),\n                    list: self.list_extensions,\n                    placement: \"top\"\n                });\n            })\n            .on(\"mousedown\", e => {\n                e.preventDefault();\n            });\n\n        // genome extension\n        this.select_genome = new Select.View({\n            css: \"upload-footer-selection\",\n            container: this.$(\".upload-footer-genome\"),\n            data: this.list_genomes,\n            value: this.options.default_genome\n        });\n\n        // listener for collection triggers on change in composite datatype and extension selection\n        this.listenTo(this.collection, \"add\", model => {\n            self._eventAnnounce(model);\n        });\n        this.listenTo(this.collection, \"change add\", () => {\n            self.render();\n        });\n        this.select_extension.options.onchange(this.select_extension.value());\n        this.render();\n    },\n\n    render: function() {\n        var model = this.collection.first();\n        if (model && model.get(\"status\") == \"running\") {\n            this.select_genome.disable();\n            this.select_extension.disable();\n        } else {\n            this.select_genome.enable();\n            this.select_extension.enable();\n        }\n        if (this.collection.where({ status: \"ready\" }).length == this.collection.length && this.collection.length > 0) {\n            this.btnStart.enable();\n            this.btnStart.$el.addClass(\"btn-primary\");\n        } else {\n            this.btnStart.disable();\n            this.btnStart.$el.removeClass(\"btn-primary\");\n        }\n        this.$(\".upload-table\")[this.collection.length > 0 ? \"show\" : \"hide\"]();\n    },\n\n    //\n    // upload events / process pipeline\n    //\n\n    /** Builds the basic ui with placeholder rows for each composite data type file */\n    _eventAnnounce: function(model) {\n        var upload_row = new UploadRow(this, { model: model });\n        this.$(\".upload-table > tbody:first\").append(upload_row.$el);\n        this.$(\".upload-table\")[this.collection.length > 0 ? \"show\" : \"hide\"]();\n        upload_row.render();\n    },\n\n    /** Start upload process */\n    _eventStart: function() {\n        var self = this;\n        this.collection.each(model => {\n            model.set({\n                genome: self.select_genome.value(),\n                extension: self.select_extension.value()\n            });\n        });\n        $.uploadpost({\n            url: this.app.options.nginx_upload_path,\n            data: this.app.toData(this.collection.filter()),\n            success: function(message) {\n                self._eventSuccess(message);\n            },\n            error: function(message) {\n                self._eventError(message);\n            },\n            progress: function(percentage) {\n                self._eventProgress(percentage);\n            }\n        });\n    },\n\n    /** Refresh progress state */\n    _eventProgress: function(percentage) {\n        this.collection.each(it => {\n            it.set(\"percentage\", percentage);\n        });\n    },\n\n    /** Refresh success state */\n    _eventSuccess: function(message) {\n        this.collection.each(it => {\n            it.set(\"status\", \"success\");\n        });\n        Galaxy.currHistoryPanel.refreshContents();\n    },\n\n    /** Refresh error state */\n    _eventError: function(message) {\n        this.collection.each(it => {\n            it.set({ status: \"error\", info: message });\n        });\n    },\n\n    /** Load html template */\n    _template: function() {\n        return (\n            '<div class=\"upload-view-composite\">' +\n            '<div class=\"upload-top\">' +\n            '<h6 class=\"upload-top-info\"/>' +\n            \"</div>\" +\n            '<div class=\"upload-box\">' +\n            '<table class=\"upload-table ui-table-striped\" style=\"display: none;\">' +\n            \"<thead>\" +\n            \"<tr>\" +\n            \"<th/>\" +\n            \"<th/>\" +\n            \"<th>Description</th>\" +\n            \"<th>Name</th>\" +\n            \"<th>Size</th>\" +\n            \"<th>Settings</th>\" +\n            \"<th>Status</th>\" +\n            \"</tr>\" +\n            \"</thead>\" +\n            \"<tbody/>\" +\n            \"</table>\" +\n            \"</div>\" +\n            '<div class=\"upload-footer\">' +\n            '<span class=\"upload-footer-title\">Composite Type:</span>' +\n            '<span class=\"upload-footer-extension\"/>' +\n            '<span class=\"upload-footer-extension-info upload-icon-button fa fa-search\"/> ' +\n            '<span class=\"upload-footer-title\">Genome/Build:</span>' +\n            '<span class=\"upload-footer-genome\"/>' +\n            \"</div>\" +\n            '<div class=\"upload-buttons\"/>' +\n            \"</div>\"\n        );\n    }\n});\n"]}