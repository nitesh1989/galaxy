{"version":3,"sources":["utils/uploadbox.js"],"names":["$","jQuery","event","props","push","uploadpost","config","cnf","extend","data","success","error","progress","url","maxfilesize","error_filesize","error_default","error_server","error_message","form","key","append","payload","sizes","files","name","d","size","file","xhr","open","XMLHttpRequest","setRequestHeader","onreadystatechange","readyState","DONE","response","extra_info","responseText","err_msg","status","text","statusText","upload","addEventListener","e","lengthComputable","Math","round","loaded","total","Galaxy","emit","debug","send","ondragleave","options","multiple","opts","$input","change","onchange","val","preventDefault","target","this","el","stopPropagation","dataTransfer","dialog","ondragover","on","dragover","fn","uploadbox","queue_length","length","queue_running","index","undefined","queue_stop","_","each","mode","filter","queue","f","remove","duplicate","String","queue_index","announce","process","complete","initialize","message","uploadinput","percentage","dragleave","m","add","select","start","stop","reset","configure","compatible","window","File","FormData","FileList"],"mappings":"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","file":"../../scripts/utils/uploadbox.js","sourcesContent":["/*\n    galaxy upload plugins - requires FormData and XMLHttpRequest\n*/\n($ => {\n    // add event properties\n    jQuery.event.props.push(\"dataTransfer\");\n\n    /**\n        Posts file data to the API\n    */\n    $.uploadpost = config => {\n        // parse options\n        var cnf = $.extend(\n            {},\n            {\n                data: {},\n                success: function() {},\n                error: function() {},\n                progress: function() {},\n                url: null,\n                maxfilesize: 2048,\n                error_filesize: \"File exceeds 2GB. Please use a FTP client.\",\n                error_default: \"Please make sure the file is available.\",\n                error_server: \"Upload request failed.\",\n                error_login: \"Uploads require you to log in.\"\n            },\n            config\n        );\n\n        // link data\n        var data = cnf.data;\n\n        // check errors\n        if (data.error_message) {\n            cnf.error(data.error_message);\n            return;\n        }\n\n        // construct form data\n        var form = new FormData();\n        for (var key in data.payload) {\n            form.append(key, data.payload[key]);\n        }\n\n        // add files to submission\n        var sizes = 0;\n        for (var key in data.files) {\n            var d = data.files[key];\n            form.append(d.name, d.file, d.file.name);\n            sizes += d.file.size;\n        }\n\n        // check file size, unless it's an ftp file\n        if (sizes > 1048576 * cnf.maxfilesize) {\n            cnf.error(cnf.error_filesize);\n            return;\n        }\n\n        // prepare request\n        var xhr = new XMLHttpRequest();\n        xhr.open(\"POST\", cnf.url, true);\n        xhr.setRequestHeader(\"Accept\", \"application/json\");\n        xhr.setRequestHeader(\"Cache-Control\", \"no-cache\");\n        xhr.setRequestHeader(\"X-Requested-With\", \"XMLHttpRequest\");\n\n        // captures state changes\n        xhr.onreadystatechange = () => {\n            // check for request completed, server connection closed\n            if (xhr.readyState == xhr.DONE) {\n                // parse response\n                var response = null;\n                var extra_info = \"\";\n                if (xhr.responseText) {\n                    try {\n                        response = jQuery.parseJSON(xhr.responseText);\n                        extra_info = response.err_msg;\n                    } catch (e) {\n                        response = xhr.responseText;\n                        extra_info = response;\n                    }\n                }\n                // pass any error to the error option\n                if (xhr.status < 200 || xhr.status > 299) {\n                    var text = xhr.statusText;\n                    if (xhr.status == 403) {\n                        text = cnf.error_login;\n                    } else if (xhr.status == 0) {\n                        text = cnf.error_server;\n                    } else if (!text) {\n                        text = cnf.error_default;\n                    }\n                    cnf.error(`${text} (${xhr.status}). ${extra_info}`);\n                } else {\n                    cnf.success(response);\n                }\n            }\n        };\n\n        // prepare upload progress\n        xhr.upload.addEventListener(\n            \"progress\",\n            e => {\n                if (e.lengthComputable) {\n                    cnf.progress(Math.round(e.loaded * 100 / e.total));\n                }\n            },\n            false\n        );\n\n        // send request\n        Galaxy.emit.debug(\"uploadbox::uploadpost()\", \"Posting following data.\", cnf);\n        xhr.send(form);\n    };\n\n    /**\n        Handles the upload events drag/drop etc.\n    */\n    $.fn.uploadinput = function(options) {\n        // initialize\n        var el = this;\n        var opts = $.extend(\n            {},\n            {\n                ondragover: function() {},\n                ondragleave: function() {},\n                onchange: function() {},\n                multiple: false\n            },\n            options\n        );\n\n        // append hidden upload field\n        var $input = $(`<input type=\"file\" style=\"display: none\" ${(opts.multiple && \"multiple\") || \"\"}/>`);\n        el.append(\n            $input.change(function(e) {\n                opts.onchange(e.target.files);\n                $(this).val(\"\");\n            })\n        );\n\n        // drag/drop events\n        el.on(\"drop\", e => {\n            opts.ondragleave(e);\n            if (e.dataTransfer) {\n                opts.onchange(e.dataTransfer.files);\n                e.preventDefault();\n            }\n        });\n        el.on(\"dragover\", e => {\n            e.preventDefault();\n            opts.ondragover(e);\n        });\n        el.on(\"dragleave\", e => {\n            e.stopPropagation();\n            opts.ondragleave(e);\n        });\n\n        // exports\n        return {\n            dialog: function() {\n                $input.trigger(\"click\");\n            }\n        };\n    };\n\n    /**\n        Handles the upload queue and events such as drag/drop etc.\n    */\n    $.fn.uploadbox = function(options) {\n        // parse options\n        var opts = $.extend(\n            {},\n            {\n                dragover: function() {},\n                dragleave: function() {},\n                announce: function(d) {},\n                initialize: function(d) {},\n                progress: function(d, m) {},\n                success: function(d, m) {},\n                error: function(d, m) {\n                    alert(m);\n                },\n                complete: function() {}\n            },\n            options\n        );\n\n        // file queue\n        var queue = {};\n\n        // queue index/length counter\n        var queue_index = 0;\n        var queue_length = 0;\n\n        // indicates if queue is currently running\n        var queue_running = false;\n        var queue_stop = false;\n\n        // element\n        var uploadinput = $(this).uploadinput({\n            multiple: true,\n            onchange: function(files) {\n                add(files);\n            },\n            ondragover: options.ondragover,\n            ondragleave: options.ondragleave\n        });\n\n        // add new files to upload queue\n        function add(files) {\n            if (files && files.length && !queue_running) {\n                var index = undefined;\n                _.each(files, (file, key) => {\n                    if (\n                        file.mode !== \"new\" &&\n                        _.filter(queue, f => f.name === file.name && f.size === file.size).length\n                    ) {\n                        file.duplicate = true;\n                    }\n                });\n                _.each(files, file => {\n                    if (!file.duplicate) {\n                        index = String(queue_index++);\n                        queue[index] = file;\n                        opts.announce(index, queue[index]);\n                        queue_length++;\n                    }\n                });\n                return index;\n            }\n        }\n\n        // remove file from queue\n        function remove(index) {\n            if (queue[index]) {\n                delete queue[index];\n                queue_length--;\n            }\n        }\n\n        // process an upload, recursive\n        function process() {\n            // validate\n            if (queue_length == 0 || queue_stop) {\n                queue_stop = false;\n                queue_running = false;\n                opts.complete();\n                return;\n            } else {\n                queue_running = true;\n            }\n\n            // get an identifier from the queue\n            var index = -1;\n            for (var key in queue) {\n                index = key;\n                break;\n            }\n\n            // get current file from queue\n            var file = queue[index];\n\n            // remove from queue\n            remove(index);\n\n            // create and submit data\n            $.uploadpost({\n                url: opts.url,\n                data: opts.initialize(index),\n                success: function(message) {\n                    opts.success(index, message);\n                    process();\n                },\n                error: function(message) {\n                    opts.error(index, message);\n                    process();\n                },\n                progress: function(percentage) {\n                    opts.progress(index, percentage);\n                }\n            });\n        }\n\n        /*\n            public interface\n        */\n\n        // open file browser for selection\n        function select() {\n            uploadinput.dialog();\n        }\n\n        // remove all entries from queue\n        function reset(index) {\n            for (index in queue) {\n                remove(index);\n            }\n        }\n\n        // initiate upload process\n        function start() {\n            if (!queue_running) {\n                queue_running = true;\n                process();\n            }\n        }\n\n        // stop upload process\n        function stop() {\n            queue_stop = true;\n        }\n\n        // set options\n        function configure(options) {\n            opts = $.extend({}, opts, options);\n            return opts;\n        }\n\n        // verify browser compatibility\n        function compatible() {\n            return window.File && window.FormData && window.XMLHttpRequest && window.FileList;\n        }\n\n        // export functions\n        return {\n            select: select,\n            add: add,\n            remove: remove,\n            start: start,\n            stop: stop,\n            reset: reset,\n            configure: configure,\n            compatible: compatible\n        };\n    };\n})(jQuery);\n"]}